<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="header_profile">Профиль</title>
    <link rel="stylesheet" href="static/profile.css" />
    <link rel="icon" type="image/png" href="static/img/logosite.svg?v=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
</head>
<body>
<canvas id="stars"></canvas>


<!-- Header -->
<header class="header">
    <div class="container header-inner">

        <button id="burger" class="burger-btn" aria-label="Открыть меню" aria-expanded="false">
            <span></span><span></span><span></span>
        </button>

        <div class="mobile-menu" id="mobileMenu">
            <button class="close-btn" id="closeMenu" aria-label="Закрыть">×</button>

            {% if request.cookies.get('user_email') %}
            <a href="/profile" class="menu-cta" data-i18n="header_profile">Профиль</a>
            {% else %}
            <a href="/auth" class="menu-cta" data-i18n="header_register">Зарегистрироваться</a>
            {% endif %}

            <nav class="mobile-nav">
                <a href="/go-to-signals" data-i18n="header_signals">Сигналы</a>
                <a href="/#about" data-i18n="header_about">О софте</a>
                <a href="/#advantages" data-i18n="header_risks">Виды риска</a>
                <a href="/#instruction" data-i18n="header_instruction">Инструкция</a>
            </nav>
        </div>

        <a href="/" class="logo-link">
            <img src="static/img/QomexLogo%202.svg" alt="QOMEX Logo" class="logo" />
        </a>

        <nav class="nav">
            <a href="/#about" data-i18n="header_about">О софте</a>
            <a href="/#advantages" data-i18n="header_risks">Виды риска</a>
            <a href="/go-to-signals" data-i18n="header_signals">Сигналы</a>
            <a href="/#instruction" data-i18n="header_instruction">Инструкция</a>
        </nav>

        <div class="header-right">
            {% if request.cookies.get("user_email") %}
            <a href="/profile" class="contact-btn">
                <span data-i18n="header_profile">Профиль</span>
            </a>
            {% else %}
            <a href="/auth" class="contact-btn">
                <span data-i18n="header_register">Зарегистрироваться</span>
            </a>
            {% endif %}
        </div>

        <div class="language-icons">
            <img src="/static/img/ru.svg" alt="RU" class="lang-icon" data-lang="ru">
            <img src="/static/img/en.svg" alt="EN" class="lang-icon" data-lang="en">
            <img src="/static/img/ua.svg" alt="UA" class="lang-icon" data-lang="ua">
        </div>
    </div>
</header>


<!-- Профиль -->
<main class="profile">
    <div class="profile-top">
        <img src="/static/img/UserAvatar.svg" alt="User Icon" class="avatar" />
        <p><span data-i18n="welcome">Добро пожаловать,</span> {{user.login}}</p>
        <button class="logout" id="logout-btn" data-i18n="logout">Выйти</button>
    </div>

    <div class="profile-tabs">
        <button class="tab-btn active" data-tab="dashboard" data-i18n="dashboard">Дашборд</button>
        <button class="tab-btn" data-tab="reset" data-i18n="reset">Сброс пароля</button>
        <button class="tab-btn disabled" disabled data-i18n="referral">Реф. система</button>
    </div>

    <div class="tab-content active" id="dashboard">
        <form id="profile-form" class="form-grid">
            <div class="form-column">
                <label data-i18n="your_login">Ваш логин</label>
                <input type="text" value="{{ user.login }}" disabled />

                <label data-i18n="your_email">Ваша почта</label>
                <input type="email" value="{{ user.email }}" disabled />

                <label data-i18n="your_trader_id">Ваш трейдер ID</label>
                <input type="text" value="{{ user.trader_id }}" disabled />
            </div>

            <div class="form-column">
                <label data-i18n="personal_phone">Личный номер телефона (необязательно)</label>
                <input type="text" id="phone-personal" />

                <label data-i18n="work_phone">Рабочий номер телефона (необязательно)</label>
                <input type="text" id="phone-work" />

                <label data-i18n="country_city">Страна, город (необязательно)</label>
                <input type="text" id="location" />
            </div>

            <div class="button-container">
                <button type="submit" class="save-btn" data-i18n="save_btn">Сохранить данные</button>
            </div>
        </form>
    </div>

    <div class="tab-content" id="reset">
  <p data-i18n="reset_text">
    Чтобы изменить пароль, отправьте запрос на ваш email.<br>
    Вы получите ссылку для сброса пароля.
  </p>

  <form id="profile-password-reset-form" class="form-grid" style="max-width:460px;">
    <label for="profile-reset-email" data-i18n="your_email">Ваша почта</label>
    <input
      type="email"
      id="profile-reset-email"
      name="email"
      value="{{ user.email }}"
      placeholder="user@example.com"
      required
      style="width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#111;color:#fff"
    />

    <button type="submit" class="save-btn" style="margin-top:12px;" data-i18n="send_link">
      Отправить ссылку
    </button>

    <div id="profile-reset-msg" style="display:none;margin-top:8px;color:#bbb;"></div>
  </form>
</div>


    <div class="tab-content" id="referral">
        <p data-i18n="referral_soon">Скоро</p>
    </div>
</main>

<script src="/static/js/profile.js?v=3"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('profile-password-reset-form');
  if (!form) return;

  const emailEl = document.getElementById('profile-reset-email');
  const msg = document.getElementById('profile-reset-msg');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = (emailEl?.value || '').trim();
    if (!email) return;

    if (msg) { msg.style.display = 'none'; msg.textContent = ''; }

    try {
      const res = await fetch('/password-reset-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });
      const data = await res.json().catch(() => ({}));
      const ok = data.success === true || data.ok === true;

      if (ok && data.reset_url) {
        // мгновенный переход на форму смены пароля
        window.location.href = data.reset_url;
        return;
      }

      // если reset_url нет (например, email не найден) — покажем сообщение
      if (msg) {
        msg.style.display = 'block';
        msg.textContent = ok
          ? 'Если email существует, ссылка для сброса отправлена.'
          : (data.message || data.detail || 'Ошибка. Попробуйте позже.');
      }
    } catch {
      if (msg) {
        msg.style.display = 'block';
        msg.textContent = 'Сеть недоступна. Попробуйте позже.';
      }
    }
  });
});
</script>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const burger = document.getElementById('burger');
        const menu   = document.getElementById('mobileMenu');
        const close  = document.getElementById('closeMenu');

        // создаём/используем backdrop
        let backdrop = document.querySelector('.menu-backdrop');
        if (!backdrop) {
            backdrop = document.createElement('div');
            backdrop.className = 'menu-backdrop';
            document.body.appendChild(backdrop);
        }

        // если меню вдруг оказалось внутри header — вынесем в body
        if (menu && menu.parentElement !== document.body) {
            document.body.appendChild(menu);
        }

        const openMenu  = () => {
            menu.classList.add('show');
            backdrop.classList.add('show');
            burger?.classList.add('active');
            burger?.setAttribute('aria-expanded', 'true');
            document.body.style.overflow = 'hidden';
        };
        const closeMenu = () => {
            menu.classList.remove('show');
            backdrop.classList.remove('show');
            burger?.classList.remove('active');
            burger?.setAttribute('aria-expanded', 'false');
            document.body.style.overflow = '';
        };

        burger?.addEventListener('click', () => {
            const opened = menu.classList.contains('show');
            opened ? closeMenu() : openMenu();
        });
        close?.addEventListener('click', closeMenu);
        backdrop.addEventListener('click', closeMenu);
        menu.querySelectorAll('a').forEach(a => a.addEventListener('click', closeMenu));
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('logout-btn');
  if (!btn) return;
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      await fetch('/logout', { method: 'POST' });
    } catch (_) {}
    location.href = '/';
  });
});
</script>

</body>
</html>
