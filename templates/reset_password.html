<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Смена пароля — QOMEX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/static/img/logosite.svg?v=1">
  <link rel="stylesheet" href="/static/reset.css">

  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',sans-serif;background:#0f0f0f;color:#fff}
    canvas#stars{position:fixed;inset:0;z-index:-1;width:100%;height:100%}
    .container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .panel{width:100%;max-width:520px}
    .lang-bar{display:flex;justify-content:center;gap:10px;margin-bottom:12px}
    .lang-icon{width:28px;height:20px;cursor:pointer;opacity:.6;filter:grayscale(40%);border-radius:3px;transition:transform .15s,opacity .15s,filter .15s}
    .lang-icon:hover{opacity:.9;filter:grayscale(0%)}
    .lang-icon.active{opacity:1;filter:none;transform:scale(1.06)}

    .form-wrapper{width:100%;background:#1b1b1e;border-radius:16px;padding:24px}
    h2{margin:0 0 12px 0}
    label{display:block;margin-top:12px;margin-bottom:6px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
    button{margin-top:16px;width:100%;padding:12px;border:0;border-radius:12px;background:linear-gradient(90deg,#d44aff,#6f4aff);color:#fff;font-weight:700;cursor:pointer}
    .error{background:#2b1a1a;color:#ff8b8b;padding:10px;border-radius:8px;margin-bottom:10px}
    .success{background:#1a2b1a;color:#86ff86;padding:10px;border-radius:8px}
    .hint{font-size:13px;color:#bbb;margin-top:6px}
    .muted{color:#aaa}
  </style>
</head>
<body>
  <canvas id="stars"></canvas>

  <div class="container">
    <div class="panel">

      <!-- Языковая панель -->
      <div class="lang-bar">
        <img src="/static/img/ru.svg" alt="RU" class="lang-icon" data-lang="ru">
        <img src="/static/img/en.svg" alt="EN" class="lang-icon" data-lang="en">
        <img src="/static/img/ua.svg" alt="UA" class="lang-icon" data-lang="ua">
      </div>

      <div class="form-wrapper">
        <h2 id="t-title">Установить новый пароль</h2>

        {% if invalid %}
          <div id="t-invalid" class="error">
            Ссылка для смены пароля недействительна или устарела. Пожалуйста, запросите сброс ещё раз на странице входа.
          </div>
        {% endif %}

        <div id="rp-error" class="error" style="display:none;"></div>

        <form id="rp-form">
          <!-- токен из бэка -->
          <input id="rp-token" value="{{ token }}" style="display:none;">

          <label for="rp-password" id="t-label-new">Новый пароль</label>
          <input type="password" id="rp-password" placeholder="Введите новый пароль" required>

          <label for="rp-password2" id="t-label-repeat">Повторите пароль</label>
          <input type="password" id="rp-password2" placeholder="Повторите пароль" required>

          <div id="t-hint" class="hint">Минимум 6 символов. Используйте буквы и цифры.</div>

          <button type="submit" id="t-save" {% if invalid %}disabled{% endif %}>Сохранить</button>
        </form>

        <div id="rp-success" class="success" style="display:none; margin-top:10px;"></div>
        <p id="t-redirect" class="muted" style="display:none;margin-top:6px;">Перенаправление на страницу входа…</p>
      </div>
    </div>
  </div>

  <script>
    // звёздный фон
    (function () {
      const canvas = document.getElementById("stars");
      if (!canvas || !canvas.getContext) return;
      const ctx = canvas.getContext("2d");
      function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
      resize(); addEventListener("resize", resize);
      const stars = Array.from({length:250}, () => ({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        r: Math.random()*1.5,
        d: Math.random()*0.5 + 0.1
      }));
      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle="#fff";
        for(const s of stars){ ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); s.y+=s.d; if(s.y>canvas.height){ s.y=0; s.x=Math.random()*canvas.width; } }
        requestAnimationFrame(draw);
      }
      draw();
    })();

    document.addEventListener("DOMContentLoaded", () => {
      // --- i18n ---
      const translations = {
        ru: {
          title: "Установить новый пароль",
          invalid: "Ссылка для смены пароля недействительна или устарела. Пожалуйста, запросите сброс ещё раз на странице входа.",
          labelNew: "Новый пароль",
          labelRepeat: "Повторите пароль",
          phNew: "Введите новый пароль",
          phRepeat: "Повторите пароль",
          hint: "Минимум 6 символов. Используйте буквы и цифры.",
          save: "Сохранить",
          success: "Пароль обновлён.",
          redirect: "Перенаправление на страницу входа…",
          errors: {
            tokenMissing: "Токен отсутствует. Запросите сброс пароля ещё раз.",
            tooShort: "Пароль должен быть не короче 6 символов.",
            mismatch: "Пароли не совпадают.",
            network: "Сеть недоступна. Попробуйте позже.",
            generic: "Ошибка. Попробуйте снова."
          }
        },
        en: {
          title: "Set a new password",
          invalid: "The reset link is invalid or expired. Please request a new reset link on the login page.",
          labelNew: "New password",
          labelRepeat: "Repeat password",
          phNew: "Enter new password",
          phRepeat: "Repeat password",
          hint: "Minimum 6 characters. Use letters and numbers.",
          save: "Save",
          success: "Password updated.",
          redirect: "Redirecting to the login page…",
          errors: {
            tokenMissing: "Token is missing. Please request a password reset again.",
            tooShort: "Password must be at least 6 characters.",
            mismatch: "Passwords do not match.",
            network: "Network unavailable. Try again later.",
            generic: "Error. Please try again."
          }
        },
        ua: {
          title: "Встановіть новий пароль",
          invalid: "Посилання на зміну пароля недійсне або застаріло. Будь ласка, запросіть скидання ще раз на сторінці входу.",
          labelNew: "Новий пароль",
          labelRepeat: "Повторіть пароль",
          phNew: "Введіть новий пароль",
          phRepeat: "Повторіть пароль",
          hint: "Мінімум 6 символів. Використовуйте літери та цифри.",
          save: "Зберегти",
          success: "Пароль оновлено.",
          redirect: "Перенаправлення на сторінку входу…",
          errors: {
            tokenMissing: "Відсутній токен. Запросіть скидання пароля ще раз.",
            tooShort: "Пароль має бути не коротшим за 6 символів.",
            mismatch: "Паролі не збігаються.",
            network: "Мережа недоступна. Спробуйте пізніше.",
            generic: "Помилка. Спробуйте ще раз."
          }
        }
      };

      let currentLang = localStorage.getItem("lang") || "ru";
      if (!translations[currentLang]) currentLang = "ru";

      const $ = (id) => document.getElementById(id);
      const t = () => translations[currentLang];

      function translatePage() {
        const S = t();
        const title = $("t-title");
        const invalid = $("t-invalid");
        const labelNew = $("t-label-new");
        const labelRepeat = $("t-label-repeat");
        const phNew = $("rp-password");
        const phRepeat = $("rp-password2");
        const hint = $("t-hint");
        const save = $("t-save");
        const redirect = $("t-redirect");

        if (title) title.textContent = S.title;
        if (invalid) invalid.textContent = S.invalid;
        if (labelNew) labelNew.textContent = S.labelNew;
        if (labelRepeat) labelRepeat.textContent = S.labelRepeat;
        if (phNew) phNew.setAttribute("placeholder", S.phNew);
        if (phRepeat) phRepeat.setAttribute("placeholder", S.phRepeat);
        if (hint) hint.textContent = S.hint;
        if (save) save.textContent = S.save;
        if (redirect && redirect.style.display !== "none") redirect.textContent = S.redirect;

        // активная иконка
        document.querySelectorAll(".lang-icon").forEach(icon => {
          icon.classList.toggle("active", icon.dataset.lang === currentLang);
        });
      }

      // иконки языков
      document.querySelectorAll(".lang-icon").forEach(icon => {
        icon.addEventListener("click", () => {
          const lang = icon.dataset.lang;
          if (lang && translations[lang]) {
            currentLang = lang;
            localStorage.setItem("lang", lang);
            translatePage();
          }
        });
      });

      translatePage();

      // --- логика формы ---
      const form = $("rp-form");
      const tokenEl = $("rp-token");
      const p1 = $("rp-password");
      const p2 = $("rp-password2");
      const err = $("rp-error");
      const ok = $("rp-success");
      const redirectMsg = $("t-redirect");

      // Фолбэк: если по какой-то причине токен пуст — возьмём его из URL
      (function ensureToken(){
        if (tokenEl && (!tokenEl.value || tokenEl.value.trim()==="")) {
          const urlToken = new URLSearchParams(location.search).get("token");
          if (urlToken) tokenEl.value = urlToken;
        }
      })();

      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          // сброс сообщений
          err.style.display = "none"; err.textContent = "";
          ok.style.display = "none"; ok.textContent = "";
          redirectMsg.style.display = "none";

          const token = (tokenEl?.value || "").trim();
          const password = (p1?.value || "").trim();
          const password2 = (p2?.value || "").trim();

          const S = t();

          if (!token) {
            err.textContent = S.errors.tokenMissing;
            err.style.display = "block";
            return;
          }
          if (!password || password.length < 6) {
            err.textContent = S.errors.tooShort;
            err.style.display = "block";
            return;
          }
          if (password !== password2) {
            err.textContent = S.errors.mismatch;
            err.style.display = "block";
            return;
          }

          try {
            const res = await fetch("/password-reset", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token: token, new_password: password })
            });

            const data = await res.json().catch(() => ({}));
            if (res.ok && (data.success === true || data.ok === true)) {
              ok.textContent = data.message || S.success;
              ok.style.display = "block";
              form.reset();
              redirectMsg.textContent = S.redirect;
              redirectMsg.style.display = "block";
              // авто-редирект на /auth
              setTimeout(() => { window.location.href = "/auth"; }, 2000);
            } else {
              err.textContent = data.message || data.detail || S.errors.generic;
              err.style.display = "block";
            }
          } catch {
            err.textContent = S.errors.network;
            err.style.display = "block";
          }
        });
      }
    });
  </script>
</body>
</html>
