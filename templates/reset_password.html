<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Смена пароля — QOMEX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/static/img/logosite.svg?v=1">
  <link rel="stylesheet" href="/static/reset.css">

  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',sans-serif;background:#0f0f0f;color:#fff}
    canvas#stars{position:fixed;inset:0;z-index:-1;width:100%;height:100%}
    .container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .form-wrapper{width:100%;max-width:420px;background:#1b1b1e;border-radius:16px;padding:24px}
    h2{margin:0 0 12px 0}
    label{display:block;margin-top:12px;margin-bottom:6px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
    button{margin-top:16px;width:100%;padding:12px;border:0;border-radius:12px;background:linear-gradient(90deg,#d44aff,#6f4aff);color:#fff;font-weight:700;cursor:pointer}
    .error{background:#2b1a1a;color:#ff8b8b;padding:10px;border-radius:8px;margin-bottom:10px}
    .success{background:#1a2b1a;color:#86ff86;padding:10px;border-radius:8px}
    .hint{font-size:13px;color:#bbb;margin-top:6px}
    .muted{color:#aaa}
  </style>
</head>
<body>
  <canvas id="stars"></canvas>

  <div class="container">
    <div class="form-wrapper">
      <h2>Установить новый пароль</h2>

      {% if invalid %}
        <div class="error">
          Ссылка для смены пароля недействительна или устарела. Пожалуйста, запросите сброс ещё раз на странице входа.
        </div>
      {% endif %}

      <div id="rp-error" class="error" style="display:none;"></div>

      <form id="rp-form">
        <!-- токен из бэка -->
        <input id="rp-token" value="{{ token }}" style="display:none;">
        <label for="rp-password">Новый пароль</label>
        <input type="password" id="rp-password" placeholder="Введите новый пароль" required>

        <label for="rp-password2">Повторите пароль</label>
        <input type="password" id="rp-password2" placeholder="Повторите пароль" required>

        <div class="hint">Минимум 6 символов. Используйте буквы и цифры.</div>

        <button type="submit" {% if invalid %}disabled{% endif %}>Сохранить</button>
      </form>

      <div id="rp-success" class="success" style="display:none; margin-top:10px;"></div>
      <p id="rp-redirect-msg" class="muted" style="display:none;margin-top:6px;">Перенаправление на страницу входа…</p>
    </div>
  </div>

  <script>
    // звёздный фон (лайт)
    (function () {
      const canvas = document.getElementById("stars");
      if (!canvas || !canvas.getContext) return;
      const ctx = canvas.getContext("2d");
      function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
      resize(); addEventListener("resize", resize);
      const stars = Array.from({length:250}, () => ({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        r: Math.random()*1.5,
        d: Math.random()*0.5 + 0.1
      }));
      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle="#fff";
        for(const s of stars){ ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); s.y+=s.d; if(s.y>canvas.height){ s.y=0; s.x=Math.random()*canvas.width; } }
        requestAnimationFrame(draw);
      }
      draw();
    })();

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("rp-form");
      const tokenEl = document.getElementById("rp-token");
      const p1 = document.getElementById("rp-password");
      const p2 = document.getElementById("rp-password2");
      const err = document.getElementById("rp-error");
      const ok = document.getElementById("rp-success");
      const redirectMsg = document.getElementById("rp-redirect-msg");

      // Фолбэк: если по какой-то причине токен пуст — возьмём его из URL
      (function ensureToken(){
        if (tokenEl && (!tokenEl.value || tokenEl.value.trim()==="")) {
          const urlToken = new URLSearchParams(location.search).get("token");
          if (urlToken) tokenEl.value = urlToken;
        }
      })();

      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          err.style.display = "none"; err.textContent = "";
          ok.style.display = "none"; ok.textContent = "";
          redirectMsg.style.display = "none";

          const token = (tokenEl?.value || "").trim();
          const password = (p1?.value || "").trim();
          const password2 = (p2?.value || "").trim();

          if (!token) {
            err.textContent = "Токен отсутствует. Запросите сброс пароля ещё раз.";
            err.style.display = "block";
            return;
          }
          if (!password || password.length < 6) {
            err.textContent = "Пароль должен быть не короче 6 символов.";
            err.style.display = "block";
            return;
          }
          if (password !== password2) {
            err.textContent = "Пароли не совпадают.";
            err.style.display = "block";
            return;
          }

          try {
            const res = await fetch("/password-reset", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token: token, new_password: password })
            });

            const data = await res.json().catch(() => ({}));
            if (res.ok && (data.success === true || data.ok === true)) {
              ok.textContent = data.message || "Пароль обновлён.";
              ok.style.display = "block";
              form.reset();
              redirectMsg.style.display = "block";
              // авто-редирект на /auth
              setTimeout(() => { window.location.href = "/auth"; }, 2000);
            } else {
              err.textContent = data.message || data.detail || "Ошибка. Попробуйте снова.";
              err.style.display = "block";
            }
          } catch {
            err.textContent = "Сеть недоступна. Попробуйте позже.";
            err.style.display = "block";
          }
        });
      }
    });
  </script>
</body>
</html>
